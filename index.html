<!DOCTYPE html>
<html>
<head>
  <title>ë‚´ ìœ„ì¹˜ ê¸°ë°˜ ë‚´ë¹„ê²Œì´ì…˜</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    #map { height: 100vh; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      font-family: sans-serif;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="controls">
    <strong>ğŸ“ ë„ì°©ì§€ ì„ íƒ:</strong><br>
    <button onclick="setMode('end')">ë„ì°©ì§€ ì„ íƒ</button><br><br>
    <strong>ğŸ” ì¥ì†Œ ê²€ìƒ‰:</strong><br>
    <input type="text" id="searchBox" placeholder="ì˜ˆ: ì„œìš¸ì—­" />
    <button onclick="searchPlace()">ê²€ìƒ‰</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil"></script>

  <script>
    const map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let endMarker = null;
    let routingControl = null;
    let currentRoute = null;
    let userLocation = null;
    let mode = 'end';

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ko-KR';
      window.speechSynthesis.speak(msg);
    }

    function drawRoute() {
      if (!userLocation || !endMarker) return;

      if (routingControl) map.removeControl(routingControl);

      speak("5ì´ˆ í›„ ì•ˆë‚´ê°€ ì‹œì‘ë©ë‹ˆë‹¤.");
      setTimeout(() => {
        map.setView(userLocation, 16);

        routingControl = L.Routing.control({
          waypoints: [userLocation, endMarker.getLatLng()],
          routeWhileDragging: false,
          show: false,
          createMarker: () => null
        }).addTo(map);

        routingControl.on('routesfound', function(e) {
          currentRoute = e.routes[0];
          const steps = currentRoute.instructions || [];
          if (steps.length > 0) {
            let delay = 0;
            steps.forEach((step, i) => {
              setTimeout(() => {
                speak(`ë‹¤ìŒ ì•ˆë‚´: ${step.text}`);
              }, delay);
              delay += 5000;
            });
          }
        });
      }, 5000);
    }

    function setMode(m) {
      mode = m;
      alert("ë„ì°©ì§€ë¥¼ ì§€ë„ì—ì„œ í´ë¦­í•˜ì„¸ìš”.");
    }

    map.on('click', function(e) {
      if (mode === 'end') {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(e.latlng).addTo(map).bindPopup("ë„ì°©ì§€").openPopup();
        drawRoute();
      }
    });

    function searchPlace() {
      const query = document.getElementById('searchBox').value;
      if (!query) return;

      L.Control.Geocoder.nominatim().geocode(query, function(results) {
        if (results.length === 0) {
          alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const result = results[0];
        map.setView(result.center, 16);
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(result.center).addTo(map).bindPopup(result.name || query).openPopup();
        drawRoute();
      });
    }

    // ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ë° ê²½ë¡œ ì´íƒˆ ê°ì§€
    navigator.geolocation.watchPosition(pos => {
      userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
      L.circle(userLocation, { radius: 5, color: 'blue' }).addTo(map);

      // ê²½ë¡œ ì´íƒˆ ê°ì§€
      if (currentRoute) {
        const snapped = L.GeometryUtil.closest(map, currentRoute.coordinates, userLocation);
        const distance = userLocation.distanceTo(snapped);
        if (distance > 50) {
          console.log("ê²½ë¡œ ì´íƒˆ ê°ì§€ë¨. ì¬íƒìƒ‰ ì¤‘...");
          drawRoute();
        }
      }
    }, err => {
      console.warn("ìœ„ì¹˜ ì¶”ì  ì‹¤íŒ¨:", err.message);
    }, {
      enableHighAccuracy: true,
      maximumAge: 1000
    });
  </script>
</body>
</html>
