<!DOCTYPE html>
<html>
<head>
  <title>ì‹¤ì‹œê°„ ë‚´ë¹„ê²Œì´ì…˜ (ìë™ ì„¼í„°ë§)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet & Plugins CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { height:100%; }
    #controls {
      position:absolute; top:10px; left:10px;
      z-index:1000; background:white; padding:10px;
      width:300px; font-family:sans-serif;
      box-shadow:0 0 5px rgba(0,0,0,0.3);
    }
    #controls input, #controls button {
      margin-bottom:6px; width:100%;
    }
    #textGuide { margin-top:10px; color:green; font-weight:bold; }
  </style>
</head>
<body>

  <div id="controls">
    <strong>ğŸ“ ë„ì°©ì§€ ì„¤ì •:</strong>
    <button onclick="setMode('end')">ì§€ë„ í´ë¦­ìœ¼ë¡œ ì„¤ì •</button>

    <strong>ğŸ” ì£¼ì†Œ/ì¥ì†Œ ê²€ìƒ‰:</strong>
    <input id="searchBox" placeholder="ì˜ˆ: ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë‚¨ì›ì‹œ ë‚´ì²™ë™ ë•ì›ì•„íŒŒíŠ¸">
    <button onclick="searchPlace()">ê²€ìƒ‰ & ì•ˆë‚´</button>

    <strong>ğŸ“Œ ìœ„ë„Â·ê²½ë„ ì…ë ¥:</strong>
    <input id="latInput" placeholder="ìœ„ë„">
    <input id="lngInput" placeholder="ê²½ë„">
    <button onclick="goToCoordinates()">ì´ë™ ë° ì•ˆë‚´</button>

    <strong>â• Plus Code ì…ë ¥:</strong>
    <input id="plusCodeInput" placeholder="ì˜ˆ: C9R8+63 ë‚¨ì›ì‹œ ì „ë¶íŠ¹ë³„ìì¹˜ë„">
    <button onclick="goToPlusCode()">ì´ë™ ë° ì•ˆë‚´</button>

    <strong>ğŸ“¶ ë‚´ ìœ„ì¹˜ Plus Code ë³´ê¸°:</strong>
    <button onclick="alert('ë‚´ ìœ„ì¹˜ Plus Code: ' + encodePlus(userLocation))">í™•ì¸í•˜ê¸°</button>

    <p id="textGuide"></p>
  </div>
  <div id="map"></div>

  <!-- Leaflet & Plugins JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil"></script>
  <!-- Plus Code JS -->
  <script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.3/openlocationcode.min.js"></script>

  <script>
    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'Â© OpenStreetMap contributors'
    }).addTo(map);

    // ì „ì—­ ë³€ìˆ˜
    let endMarker = null,
        routingControl = null,
        currentRoute = null,
        userLocation = null,
        userCircle = null,
        mode = 'end',
        routeLine = null,
        spokenSteps = new Set(),
        autoCenter = false;      // ë‚´ë¹„ê²Œì´ì…˜ ì‹œì‘ í›„ ìë™ ì„¼í„°ë§ í™œì„±í™”
    const NAV_ZOOM = 18;        // ë‚´ë¹„ê²Œì´ì…˜ ì‹œ ê³ ì •í•  ì¤Œ ë ˆë²¨

    // ìŒì„± ì•ˆë‚´
    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ko-KR';
      window.speechSynthesis.speak(u);
    }

    // ê±°ë¦¬ í¬ë§·
    function formatDistance(m) {
      return m >= 1000
        ? (m/1000).toFixed(1) + 'í‚¬ë¡œë¯¸í„°'
        : Math.round(m) + 'ë¯¸í„°';
    }

    // í•œê¸€ ì•ˆë‚´ë¬¸ ë³€í™˜
    function translateInstruction(instr) {
      const t = instr.text.toLowerCase();
      if (t.includes('left'))        return 'ì¢ŒíšŒì „ì…ë‹ˆë‹¤';
      if (t.includes('right'))       return 'ìš°íšŒì „ì…ë‹ˆë‹¤';
      if (t.includes('straight'))    return 'ì§ì§„í•˜ì„¸ìš”';
      if (t.includes('destination')) return 'ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤';
      return instr.text;
    }

    // ë‚´ë¹„ê²Œì´ì…˜ ê²½ë¡œ ê·¸ë¦¬ê¸° & 5ì´ˆ í›„ ì‹œì‘
    function drawRoute() {
      if (!userLocation || !endMarker) return;
      if (routingControl) map.removeControl(routingControl);
      if (routeLine) map.removeLayer(routeLine);
      spokenSteps.clear();
      autoCenter = false;

      speak('5ì´ˆ í›„ ì•ˆë‚´ê°€ ì‹œì‘ë©ë‹ˆë‹¤.');
      document.getElementById('textGuide').innerText = 'ğŸ•’ 5ì´ˆ í›„ ì•ˆë‚´ ì‹œì‘';

      setTimeout(() => {
        // ë‚´ë¹„ê²Œì´ì…˜ ì‹œì‘ ì‹œ ì¤Œ ê³ ì • ë° ìë™ ì„¼í„°ë§ í™œì„±í™”
        autoCenter = true;
        map.setView(userLocation, NAV_ZOOM);

        routingControl = L.Routing.control({
          waypoints:[userLocation, endMarker.getLatLng()],
          routeWhileDragging:false,
          show:false,
          createMarker:()=>null
        })
        .on('routesfound', e => {
          currentRoute = e.routes[0];
          routeLine = L.polyline(currentRoute.coordinates, {color:'red'}).addTo(map);

          // ì²« ì•ˆë‚´
          const first = currentRoute.instructions[0];
          if (first) {
            const msg = `ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ${formatDistance(first.distance)} ì•ì—ì„œ ${translateInstruction(first)}`;
            speak(msg);
            document.getElementById('textGuide').innerText = 'ğŸ“¢ ' + msg;
            spokenSteps.add(first.index);
          }
        })
        .addTo(map);
      }, 5000);
    }

    // ëª¨ë“œ ì„¤ì • (í´ë¦­ìœ¼ë¡œ ë„ì°©ì§€)
    function setMode(m) {
      mode = m;
      alert('ì§€ë„ì—ì„œ ë„ì°©ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.');
    }

    // ì§€ë„ í´ë¦­ â†’ ë„ì°©ì§€ ì„¤ì •
    map.on('click', e => {
      if (mode === 'end') {
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(e.latlng).addTo(map).bindPopup('ë„ì°©ì§€').openPopup();
        document.getElementById('textGuide').innerText =
          `ğŸ“ ë„ì°©ì§€: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
        drawRoute();
      }
    });

    // ì£¼ì†Œ/ì¥ì†Œ ê²€ìƒ‰
    function searchPlace() {
      const q = document.getElementById('searchBox').value;
      if (!q) return;
      L.Control.Geocoder.nominatim().geocode(q, res => {
        if (!res.length) return alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        const c = res[0].center;
        map.setView(c, 16);
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(c).addTo(map).bindPopup(res[0].name||q).openPopup();
        document.getElementById('textGuide').innerText = `ğŸ“ "${q}" ìœ„ì¹˜ë¡œ ì•ˆë‚´`;
        drawRoute();
      });
    }

    // ìœ„ë„Â·ê²½ë„ ì´ë™
    function goToCoordinates() {
      const lat = parseFloat(document.getElementById('latInput').value),
            lng = parseFloat(document.getElementById('lngInput').value);
      if (isNaN(lat) || isNaN(lng)) return alert('ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      const c = L.latLng(lat, lng);
      map.setView(c, 16);
      if (endMarker) map.removeLayer(endMarker);
      endMarker = L.marker(c).addTo(map).bindPopup('ë„ì°©ì§€').openPopup();
      document.getElementById('textGuide').innerText = `ğŸ“ ${lat}, ${lng} ìœ„ì¹˜ë¡œ ì•ˆë‚´`;
      drawRoute();
    }

    // Plus Code ì´ë™
    function goToPlusCode() {
      const raw = document.getElementById('plusCodeInput').value.trim();
      if (!raw) return alert('í”ŒëŸ¬ìŠ¤ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      const plus = raw.split(/\s+/)[0];
      if (!OpenLocationCode.isValidCode(plus))
        return alert('ìœ íš¨í•œ í”ŒëŸ¬ìŠ¤ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      const dec = OpenLocationCode.decode(plus);
      const c = L.latLng(dec.latitudeCenter, dec.longitudeCenter);
      map.setView(c, 16);
      if (endMarker) map.removeLayer(endMarker);
      endMarker = L.marker(c).addTo(map).bindPopup(plus).openPopup();
      document.getElementById('textGuide').innerText = `ğŸ“ ${plus} ìœ„ì¹˜ë¡œ ì•ˆë‚´`;
      drawRoute();
    }

    // ë‚´ ìœ„ì¹˜ â†’ Plus Code ì¸ì½”ë”©
    function encodePlus(latlng) {
      return latlng
        ? OpenLocationCode.encode(latlng.lat, latlng.lng)
        : 'ìœ„ì¹˜ ì—†ìŒ';
    }

    // GPS ì‹¤ì‹œê°„ ì¶”ì  & ê²½ë¡œ ë”°ë¼ê°€ê¸°/ì´íƒˆ ê°ì§€ + ìë™ ì„¼í„°ë§
    navigator.geolocation.watchPosition(pos => {
      userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);

      // ì‚¬ìš©ì ìœ„ì¹˜ ì›(circle) ê°±ì‹ 
      if (!userCircle) {
        userCircle = L.circle(userLocation, {radius:5, color:'blue'}).addTo(map);
      } else {
        userCircle.setLatLng(userLocation);
      }

      // ìë™ ì„¼í„°ë§ í™œì„±í™” ì‹œ í•­ìƒ í™”ë©´ ì¤‘ì•™ ê³ ì •
      if (autoCenter) {
        map.setView(userLocation, NAV_ZOOM);
      }

      // ê²½ë¡œ ë”°ë¼ê°€ê¸° & ì´íƒˆ ê°ì§€
      if (currentRoute && routeLine) {
        const sn = L.GeometryUtil.closest(map, currentRoute.coordinates, userLocation);
        const dist = userLocation.distanceTo(sn);
        if (dist > 50) {
          console.log('ê²½ë¡œ ì´íƒˆ, ì¬íƒìƒ‰');
          drawRoute();
          return;
        }
        const idx = currentRoute.coordinates.findIndex(
          c => c.lat === sn.lat && c.lng === sn.lng
        );
        if (idx > 0) {
          routeLine.setLatLngs(currentRoute.coordinates.slice(idx));
        }
        const next = currentRoute.instructions.find(s => !spokenSteps.has(s.index));
        if (next) {
          const dToNext = userLocation.distanceTo(next.latLng);
          if (dToNext <= next.distance) {
            const msg = `${formatDistance(next.distance)} ì•ì—ì„œ ${translateInstruction(next)}`;
            speak(msg);
            document.getElementById('textGuide').innerText = 'ğŸ“¢ ' + msg;
            spokenSteps.add(next.index);
          }
        }
      }
    }, err => {
      console.warn('GPS ì˜¤ë¥˜:', err.message);
    }, {
      enableHighAccuracy: true,
      maximumAge: 1000
    });
  </script>
</body>
</html>
